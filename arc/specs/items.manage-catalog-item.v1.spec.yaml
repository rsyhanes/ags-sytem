spec:
  id: items.manage-catalog-item.v1
  context: items

  domain:
    problem: |
      The system must allow engineers to create, update, retrieve, and list catalog items
      representing building components with a code, name, and measurement unit.
    rationale: |
      Catalog items serve as foundational components used across the business.
      Accurate and consistent management of item definitions enables downstream
      estimation, ordering, and fabrication processes.

    concepts:
      entities:
        - Item
      value_objects:
        - Measure
      domain_events:
        - ItemCreated
        - ItemUpdated

    rules:
      must:
        - "Item code must be unique."
        - "Item must contain a valid measure."
      cannot:
        - "Item cannot be created with empty code."
        - "Item cannot be updated if it doesn't exist."

    use_case:
      name: ManageCatalogItem
      trigger: "User performs create, update, list, or get actions on items."
      description: |
        Provides CRUD-style management for catalog items, enforcing validation,
        uniqueness constraints, and repository operations.
      steps:
        - Validate input
        - Ensure code uniqueness (for creation)
        - Retrieve item (for update/get)
        - Persist entity changes
        - Emit domain event for created/updated items

  interactions:
    inbound:
      api:
        - "POST /api/items"
        - "PUT /api/items/{code}"
        - "GET /api/items"
        - "GET /api/items/{code}"
      ui:
        - "Route: /items (catalog listing with search/filter/pagination)"
        - "Route: /items/new (create form with validation feedback)"
        - "Route: /items/{code}/edit (update form pre-populated with existing data)"
        - "Button interactions: Save, Cancel, Delete (with confirmation dialogs)"
        - "Form validation: Real-time client-side + server-side error handling"
        - "Data grid: Sortable, filterable, paginated item listings"
      events: []

    outbound:
      api_responses:
        - "201 Created: Item created"
        - "200 OK: Item updated"
        - "200 OK: Items listed"
        - "404 NotFound: For missing items"
        - "409 Conflict: For duplicate item code"

      events:
        - "ItemCreated"
        - "ItemUpdated"

      persistence:
        - "ItemRepositoryPort.Save(item)"
        - "ItemRepositoryPort.FindByCode(code)"
        - "ItemRepositoryPort.FindAll()"

      external_calls: []

  contracts:
    domain:
      - "../contracts/schemas/domain/item.v1.json"
      - "../contracts/schemas/domain/measure.v1.json"

    inbound:
      - "../contracts/openapi/items.v1.yaml#/paths/~1api~1items"
      - "../contracts/openapi/items.v1.yaml#/paths/~1api~1items~1{code}"

    outbound:
      - "../contracts/schemas/ports/item-repository.v1.json"
      - "../contracts/asyncapi/item-events.v1.yaml#/channels/item.created"
      - "../contracts/asyncapi/item-events.v1.yaml#/channels/item.updated"

    ui_state:
      derives_from:
        request: "../contracts/openapi/items.v1.yaml#/paths/~1api~1items"
        response: "../contracts/schemas/domain/item.v1.json"
      template:
        include_status: true
        forms:
          create_form:
            fields: [code, name, measure]
            validation_rules: ["unique_code", "required_fields", "valid_measure"]
          list_view:
            filters: [measure, search]
            pagination: true
            actions: [create, edit, delete]

  scenarios:
    # Backend API scenarios
    - name: create-item-happy-path
      given: "valid item data (code='2103', name='Frame', measure='Inches')"
      when: "CreateItem"
      then:
        - "Item created and persisted"
        - "ItemRepositoryPort.Save called with item"
        - "ItemCreated event emitted"

    - name: create-item-duplicate-code
      given: "item with existing code"
      when: "CreateItem"
      then:
        - "Conflict error"
        - "No side effects"

    - name: create-item-invalid-code
      given: "empty or invalid item code"
      when: "CreateItem"
      then:
        - "Validation error"
        - "No side effects"

    - name: update-item-happy-path
      given: "existing item and valid update data"
      when: "UpdateItem"
      then:
        - "Item updated and persisted"
        - "ItemUpdated event emitted"

    - name: update-item-not-found
      given: "non-existent item code"
      when: "UpdateItem"
      then:
        - "NotFound error"
        - "No side effects"

    - name: list-items-happy-path
      given: "items exist"
      when: "ListItems"
      then:
        - "All items returned with proper formatting"

    # Frontend UI scenarios
    - name: create-item-via-ui-success
      given: "User on create item page with valid form data"
      when: "User submits form"
      then:
        - "Item created via API call"
        - "Success notification displayed"
        - "User redirected to items list"
        - "Form resets for potential new item creation"

    - name: create-item-ui-validation
      given: "User attempts to submit invalid form"
      when: "Form validates"
      then:
        - "Validation errors shown inline"
        - "Submit button disabled"
        - "Screen reader announces errors"
        - "Form fields highlighted appropriately"

    - name: list-items-pagination
      given: "Items exceed page limit"
      when: "User navigates pagination"
      then:
        - "Correct page of items displayed"
        - "Pagination controls show current state"
        - "URL reflects current page/filter state"

    - name: item-deletion-confirmation
      given: "User attempts to delete item"
      when: "Delete action triggered"
      then:
        - "Confirmation dialog appears"
        - "Item deleted only on confirmation"
        - "List refreshes to show updated state"

    - name: accessibility-keyboard-navigation
      given: "User navigates via keyboard only"
      when: "TAB key pressed through interface"
      then:
        - "All interactive elements reachable"
        - "Focus indicators visible"
        - "Current element announced by screen reader"

  nfr:
    performance:
      - "API responses: P95 < 200ms for all operations"
      - "List view renders within 100ms with 500+ items"
      - "Form validation provides immediate feedback (< 50ms)"
      - "Search/filter operations complete within 150ms"
    reliability:
      - "Form submissions retry on transient failures"
      - "Offline mode for read operations (if applicable)"
      - "Graceful degradation when API unavailable"
    usability:
      - "Forms use progressive disclosure for optional fields"
      - "Loading states shown during all async operations"
      - "Clear error messages in business domain language"
      - "Optimistic UI updates where safe"
    accessibility:
      - "All forms comply with WCAG AA standards"
      - "Screen reader support for all state changes"
      - "Color contrast meets AA minimums (4.5:1)"
      - "Keyboard navigation for all interactive elements"
      - "ARIA labels on all form inputs and controls"
    security:
      - "Input validation on both client and server"
      - "CSRF protection for mutating operations"
      - "Rate limiting on list/search operations"

  deliverables:
    # Backend Deliverables
    - "Domain entity: Item (code, name, measure) with validation rules"
    - "Value object: Measure enumeration with allowed values"
    - "Use case handlers: CreateItem, UpdateItem, ListItems, GetItem"
    - "Port interface: ItemRepositoryPort methods"
    - "HTTP API controller adapter with error handling"
    - "Repository adapter: data persistence implementation"
    - "OpenAPI spec: Complete API contract definition"
    - "Event publishing: ItemCreated/ItemUpdated via message bus"
    - "Tests: Domain entities, use cases, adapters, e2e scenarios"

    # Frontend Deliverables
    - "Angular feature module: ItemsFeature under /app/features/items/"
    - "Route configuration: items.routes.ts with lazy loading"
    - "Page components: ItemsListPage, ItemFormPage (create/update)"
    - "API service: ItemsApiService with error handling and retry logic"
    - "Reactive forms: CreateItemForm, UpdateItemForm with validation"
    - "Signals state: itemsState using NgRx signals for global mgmt"
    - "Reusable components: ItemCard, LoadingIndicator, ErrorMessage"
    - "Route guards: ItemExistsGuard, UnsavedChangesGuard"
    - "Unit tests: Services, components, state management, guards"
    - "Component tests: Page components with user interaction flows"
    - "E2E tests: Complete user journeys (create, edit, list, delete)"
    - "Accessibility tests: Axe scan compliance, keyboard navigation"
    - "Performance tests: Bundle size checks, runtime performance budgets"

  packs:
    # Core Architecture
    - "spec.linting"
    - "domain.purity"
    - "ui.state"
    - "ports.contracts"

    # Angular Implementation Standards
    - "angular.app-structure"
    - "angular.material"
    - "angular.best-practices"
    - "angular.components"
    - "angular.services"
    - "angular.state-management"
    - "angular.templates"
    - "typescript.best-practices"
    - "accessibility.requirements"
