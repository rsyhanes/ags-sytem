spec:
  id: orders.calculate-bom.v1
  objective: "As a customer or engineer, I can calculate bill of materials (BOM) from frame specifications using configured system components."
  packs: ["domain.purity", "ports.contracts", "adapters.conformance", "web-api", "calculation-engine"]
  scope:
    domain:
      - "Entity: Frame(systemCode, width, height, color, quantity)"
      - "ValueObject: BOMLine(itemCode, itemName, componentName, quantity, length, angle, measure)"
      - "ValueObject: BOM(frameSpec, bomLines, totalItems)"
      - "UseCase: CalculateBOM(systemCode, width, height, color, quantity)"
      - "UseCase: ValidateFrameSpec(systemCode, width, height, color)"
    ports:
      driving:        # offered to outside callers
        - "HTTP: POST /api/calculate-bom (OpenAPI: ../contracts/openapi/calculations.v1.yaml#/paths/~1api~1calculate-bom)"
        - "HTTP: POST /api/validate-frame (OpenAPI: ../contracts/openapi/calculations.v1.yaml#/paths/~1api~1validate-frame)"
      driven:         # required by domain (to be implemented by adapters)
        - "SystemRepositoryPort.FindByCode(code) (integration with systems.design-system.v1)"
        - "ComponentRepositoryPort.FindBySystem(systemCode) (integration with systems.configure-components.v1)"
        - "ItemRepositoryPort.FindByCode(code) (integration with items.manage-catalog-item.v1)"
        - "FormulaEnginePort.ExecuteFormula(formula, frameData) (integration with systems.configure-components.v1)"
        - "ValidationPort.ValidateFrameDimensions(frame, sizeConstraints) (Schema: ../contracts/schemas/ports/validation.v1.json)"
  nfr:
    purity: "domain.no.framework.refs"
    contracts: ["port.contract.declared", "port.contract.versioned"]
    conformance: "adapter.conforms.to.port"
    perf: "perf.p95.500ms"
    accuracy: "calculation.precision.two.decimals"
    validation: ["system.exists", "frame.within.constraints", "color.available"]
  scenarios:
    - name: calculate-bom-happy-path
      given: "valid frame spec (system='WF00', width=80, height=120, color='Bronze', qty=1)"
      when: "CalculateBOM"
      then:
        - "BOM returned with calculated components:"
        - "2x Frame Vertical (120\", 45° angle, Inches)"
        - "2x Frame Horizontal (80\", 45° angle, Inches)"
        - "2x Glass Stop Vertical (115.6\", 45° angle, Inches)"
        - "2x Glass Stop Horizontal (76.86\", 45° angle, Inches)"
        - "8x Setting Block (0, 0° angle, Units)"
    - name: calculate-bom-multiple-frames
      given: "frame spec with quantity=3"
      when: "CalculateBOM"
      then: "All component quantities multiplied by frame quantity (6x Frame Vertical, etc.)"
    - name: calculate-bom-system-not-found
      given: "non-existent system code"
      when: "CalculateBOM"
      then: "NotFound error; no calculations performed"
    - name: calculate-bom-invalid-dimensions
      given: "frame dimensions outside system size constraints"
      when: "CalculateBOM"
      then: "Validation error with specific constraint violations"
    - name: calculate-bom-invalid-color
      given: "color not available for system"
      when: "CalculateBOM"
      then: "Validation error; available colors suggested"
    - name: validate-frame-spec-happy-path
      given: "valid frame specification"
      when: "ValidateFrameSpec"
      then: "Validation passes with confirmation"
    - name: calculate-bom-formula-error
      given: "component with invalid formula"
      when: "CalculateBOM"
      then: "Calculation error with component identification"
deliverables:
  - "Domain entity: Frame with validation rules"
  - "Value objects: BOM, BOMLine with calculation metadata"
  - "Use case handlers: CalculateBOM, ValidateFrameSpec"
  - "Port interface: ValidationPort for frame constraint checking"
  - "OpenAPI spec for calculation endpoints (driving ports)"
  - "Calculation service: Orchestrates system lookup, component retrieval, and formula execution"
  - "HTTP controller adapter: REST API with detailed error responses"
  - "Tests: calculation accuracy tests, validation tests, error scenario tests, performance tests"
  - "Validation: System existence, dimension constraints, color availability, formula execution"
  - "Error handling: Detailed messages for validation failures and calculation errors"
